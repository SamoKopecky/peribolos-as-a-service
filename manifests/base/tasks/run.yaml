---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run
spec:
  params:
    - name: REPO_NAME
      type: string
      default: ".github"
    - name: SECRET_NAME
      type: string
  steps:
    - name: apply-peribolos
      image: toolbox
      volumeMounts:
        - mountPath: /mnt/secret
          name: github-token
      env:
        - name: ORG_NAME
          valueFrom:
            secretKeyRef:
              name: $(params.SECRET_NAME)
              key: orgName
      script: |
        #!/usr/bin/bash

        echo "Cloning repository..."
        # Clone repository
        git clone https://github.com/$ORG_NAME/$(params.REPO_NAME)
        cd $(params.REPO_NAME)

        # Run Peribolos on the repository
        echo "Running peribolos..."
        peribolos --config-path peribolos.yaml --github-token-path /mnt/secret/token --fix-org --fix-repos --fix-team-members --fix-teams --fix-team-repos --confirm
  volumes:
    - name: github-token
      secret:
        secretName: $(params.SECRET_NAME)
        items:
          - key: token
            path: token
        optional: false
